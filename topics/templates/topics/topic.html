{% extends "base.html" %}
{% load staticfiles %}
{% load compress %}
{% block main-content %}
<div class="row">
  <div class="col-md-9">

    <div class="topic-detail panel panel-default">
      <div class="panel-heading clearfix">
        <div class="media-body">
          <h1 class="media-heading">{{ topic.title }}</h1>
          <div class="info">
            <a class="node" href="{% url 'topics.node_list' topic.node.id %}">{{ topic.node.name }}</a>
             ·
            <a data-author="true" href="">{{ topic.user.name }}</a>
             ·
            于 <span>{{ topic.publish_time }}</span> 发布
          </div>
        </div>
        <div class="avatar media-right">
          <a href="#"><img class="media-object avatar-48" src="{{ topic.user.avatar }}" alt=""></a>
        </div>
      </div>

      <div class="panel-body">
        {{ topic.content | safe }}
      </div>

      <div class="panel-footer clearfix">
        {% if topic.user.id == user.id or user.is_admin %}
        <span class="pull-right opts">
          <a class="fa fa-pencil" title="修改本帖" href="{% url 'topics.topic_edit' topic.id %}"></a>
          <a class="fa fa-trash" title="删除本帖" onclick="return confirm('确定要删除这个帖子么？');"  href="{% url 'topics.topic_delete' topic.id %}"></a>
        </span>
        {% endif %}
      </div>

    </div><!--.topic-detail-->

    <div id="replies" class="panel panel-default" data-last-floor="1">
      <div class="total panel-heading">
        共收到 <b>{{ topic.replies_count }}</b> 条回复
      </div>
      <div class="items panel-body">
        {% for item in replies %}
          {% with item.user as reply_user %}
        <div class="reply" id="reply{{ forloop.counter }}">
          <div class="avatar"><a href="{% url 'users.user' reply_user.name %}"><img class="media-object avatar-48" src="{{ reply_user.avatar }}" alt=""></a></div>
          <div class="infos">
            <div class="info">
              <span class="name">
                <a data-name="stone" href="{% url 'users.user' reply_user.name %}">{{ reply_user.name }}</a>
              </span> ·
              <span class="time">
                <a class="reply-floor" href="#reply{{ forloop.counter }}">#{{ forloop.counter }}</a> · <abbr class="timeago" title="2016-01-08T17:33:54+08:00">2 天前</abbr>
              </span>
              <span class="opts pull-right">
                  <a title="赞" data-count="0" data-state="" data-type="Reply" data-id="285743" class="likeable " href="#"><i class="fa fa-thumbs-up"></i> <span></span></a>
                  {% if reply_user.id == user.id or user.is_admin %}
                  <a class="edit fa fa-pencil" data-uid="2938" title="修改回帖" href="{% url 'topics.reply_edit' topic.id item.id %}"></a>
                  {% endif %}
                  <a data-floor="1" data-login="stone" title="回复此楼" class="btn-reply fa fa-mail-reply" href="#"></a>
              </span>
            </div>
            <div class="contnent">
              {% if item.status == 1 %}
              {{ item.content | safe }}
              {% elif item.status == 2 %}
                <p><strike>该回复已删除</strike></p>
              {% endif %}
            </div>
          </div>
        </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div> <!--#replies-->
    <div id="reply" class="panel panel-default">
      <div class="panel-heading">回帖</div>
      <div class="panel-body">
        <form action="{% url 'topics.reply_add' topic.id %}" method="post" class="simple_form">
          {% csrf_token %}
          <div class="form-group">
            {{ form.content }}
          </div>
          <div class="form-group">
            <input class="btn btn-primary" style="padding-left: 60px;padding-right: 60px;" type="submit" value="提交回复">
          </div>
        </form>
      </div>
    </div>

  </div><!--.col-md-9-->

  <div class="sidebar col-md-3">
  {% include "right_side.html" %}
  </div><!--.sidebar .col-md-3-->

</div><!--.row-->
{% endblock %}


{% block footer-js %}
<!-- ckeditor -->
<script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
<script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
{% compress js %}
<!-- jQuery Validation -->
<script src="{% static 'jquery-validation/jquery.validate.min.js' %}"></script>
<script src="{% static 'jquery-validation/localization/messages_zh.min.js' %}"></script>
<script src="{% static 'web/js/jquery-bootstrap-validator.js' %}"></script>
{% endcompress %}
<script>
$(document).ready(function() {
  $("form").validate({
    ignore: "",
    rules: {
      content: {
        required: function (textarea) {
          CKEDITOR.instances[textarea.id].updateElement(); // update textarea
          var editorcontent = textarea.value.replace(/<[^>]*>/gi, ''); // strip tags
          return editorcontent.length === 0;
        }
      }
    }
  });

  $("form").submit(function (ev) {
    ev.preventDefault();
    var frm = $(this);
    if(! frm.valid()) return false;
    $.ajax({
      type: frm.attr('method'),
      url: frm.attr('action'),
      data: frm.serialize(),
      success: function (data) {
        $("#replies .items").append(data);
        CKEDITOR.instances['id_content'].setData('');
      }
    });
  });
});

</script>

{% endblock %}